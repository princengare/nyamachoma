<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>leo</title>
  <link rel="stylesheet" href="styles/styles-user.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
  <link rel="manifest" href="/site.webmanifest">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="title-container" style="position: relative;" onclick="window.location.href='index.html'">
        <h1 class="title" style="position: relative; z-index: 1;">nyama choma</h1> 
        <div class="title-ellipse" style="position: absolute; z-index: 0;"></div>
    </div>
    <div class="header-options">
      <div class="triangle-container">
        <div class="parallelogram"></div>
        <div class="parallelogram-text">leo</div>
      </div>
    </div>
  </div>
  <div class="gallery-container">
    <div class="column left-column">
      <div class="option-container" onclick="window.location.href='leo.html'">
        <h1 class="option-shade-1">picha</h1> 
        <h1 class="option-text">photos</h1> 
      </div>
      <div class="triangle-container-2" id="downloadToggle">
        <div class="triangle-down"></div>
        <div class="triangle-text-about">download</div>
      </div>
      <div class="download-option-container" id="downloadAllOption">
        <div class="download-option"></div>
        <div class="download-option-text">download all?</div>
      </div>
      <div class="download-option-container" id="startDownloadOption">
        <div class="download-option"></div>
        <div class="download-option-text-2">start download.</div>
      </div>
    </div>
    <div class="column right-column">
      <div class="rectangle">
        <div class="scrollable-content">
           <div class="image-column">
            <a href="images/leo/000244280007.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280007-400.webp 400w,
                    images/leo/000244280007-800.webp 800w,
                    images/leo/000244280007-1200.webp 1200w,
                    images/leo/000244280007-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280007.jpg"
                    alt="Image 1"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 4: 000244280010 -->
            <a href="images/leo/000244280010.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280010-400.webp 400w,
                    images/leo/000244280010-800.webp 800w,
                    images/leo/000244280010-1200.webp 1200w,
                    images/leo/000244280010-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280010.jpg"
                    alt="Image 4"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 7: 000244280014 -->
            <a href="images/leo/000244280014.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280014-400.webp 400w,
                    images/leo/000244280014-800.webp 800w,
                    images/leo/000244280014-1200.webp 1200w,
                    images/leo/000244280014-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280014.jpg"
                    alt="Image 7"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 10: 000244280017 -->
            <a href="images/leo/000244280017.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280017-400.webp 400w,
                    images/leo/000244280017-800.webp 800w,
                    images/leo/000244280017-1200.webp 1200w,
                    images/leo/000244280017-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280017.jpg"
                    alt="Image 10"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 13: 000244280020 -->
            <a href="images/leo/000244280020.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280020-400.webp 400w,
                    images/leo/000244280020-800.webp 800w,
                    images/leo/000244280020-1200.webp 1200w,
                    images/leo/000244280020-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280020.jpg"
                    alt="Image 13"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 16: 000244280023 -->
            <a href="images/leo/000244280023.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280023-400.webp 400w,
                    images/leo/000244280023-800.webp 800w,
                    images/leo/000244280023-1200.webp 1200w,
                    images/leo/000244280023-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280023.jpg"
                    alt="Image 16"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 19: 000244280026 -->
            <a href="images/leo/000244280026.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280026-400.webp 400w,
                    images/leo/000244280026-800.webp 800w,
                    images/leo/000244280026-1200.webp 1200w,
                    images/leo/000244280026-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280026.jpg"
                    alt="Image 19"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 22: 000244280030 -->
            <a href="images/leo/000244280030.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280030-400.webp 400w,
                    images/leo/000244280030-800.webp 800w,
                    images/leo/000244280030-1200.webp 1200w,
                    images/leo/000244280030-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280030.jpg"
                    alt="Image 22"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 25: 000244280034 -->
            <a href="images/leo/000244280034.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280034-400.webp 400w,
                    images/leo/000244280034-800.webp 800w,
                    images/leo/000244280034-1200.webp 1200w,
                    images/leo/000244280034-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280034.jpg"
                    alt="Image 25"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>
            </div>

            <div class="image-column">
            <!-- 2: 000244280008 -->
            <a href="images/leo/000244280008.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280008-400.webp 400w,
                    images/leo/000244280008-800.webp 800w,
                    images/leo/000244280008-1200.webp 1200w,
                    images/leo/000244280008-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280008.jpg"
                    alt="Image 2"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 5: 000244280011 -->
            <a href="images/leo/000244280011.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280011-400.webp 400w,
                    images/leo/000244280011-800.webp 800w,
                    images/leo/000244280011-1200.webp 1200w,
                    images/leo/000244280011-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280011.jpg"
                    alt="Image 5"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 8: 000244280015 -->
            <a href="images/leo/000244280015.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280015-400.webp 400w,
                    images/leo/000244280015-800.webp 800w,
                    images/leo/000244280015-1200.webp 1200w,
                    images/leo/000244280015-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280015.jpg"
                    alt="Image 8"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 11: 000244280018 -->
            <a href="images/leo/000244280018.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280018-400.webp 400w,
                    images/leo/000244280018-800.webp 800w,
                    images/leo/000244280018-1200.webp 1200w,
                    images/leo/000244280018-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280018.jpg"
                    alt="Image 11"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 14: 000244280021 -->
            <a href="images/leo/000244280021.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280021-400.webp 400w,
                    images/leo/000244280021-800.webp 800w,
                    images/leo/000244280021-1200.webp 1200w,
                    images/leo/000244280021-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280021.jpg"
                    alt="Image 14"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 17: 000244280024 -->
            <a href="images/leo/000244280024.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280024-400.webp 400w,
                    images/leo/000244280024-800.webp 800w,
                    images/leo/000244280024-1200.webp 1200w,
                    images/leo/000244280024-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280024.jpg"
                    alt="Image 17"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 20: 000244280028 -->
            <a href="images/leo/000244280028.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280028-400.webp 400w,
                    images/leo/000244280028-800.webp 800w,
                    images/leo/000244280028-1200.webp 1200w,
                    images/leo/000244280028-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280028.jpg"
                    alt="Image 20"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 23: 000244280031 -->
            <a href="images/leo/000244280031.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280031-400.webp 400w,
                    images/leo/000244280031-800.webp 800w,
                    images/leo/000244280031-1200.webp 1200w,
                    images/leo/000244280031-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280031.jpg"
                    alt="Image 23"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 26: 000244280035 -->
            <a href="images/leo/000244280035.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280035-400.webp 400w,
                    images/leo/000244280035-800.webp 800w,
                    images/leo/000244280035-1200.webp 1200w,
                    images/leo/000244280035-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280035.jpg"
                    alt="Image 26"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>
            </div>

            <div class="image-column">
            <!-- 3: 000244280009 -->
            <a href="images/leo/000244280009.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280009-400.webp 400w,
                    images/leo/000244280009-800.webp 800w,
                    images/leo/000244280009-1200.webp 1200w,
                    images/leo/000244280009-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280009.jpg"
                    alt="Image 3"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 6: 000244280013 -->
            <a href="images/leo/000244280013.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280013-400.webp 400w,
                    images/leo/000244280013-800.webp 800w,
                    images/leo/000244280013-1200.webp 1200w,
                    images/leo/000244280013-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280013.jpg"
                    alt="Image 6"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 9: 000244280016 -->
            <a href="images/leo/000244280016.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280016-400.webp 400w,
                    images/leo/000244280016-800.webp 800w,
                    images/leo/000244280016-1200.webp 1200w,
                    images/leo/000244280016-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280016.jpg"
                    alt="Image 9"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 12: 000244280019 -->
            <a href="images/leo/000244280019.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280019-400.webp 400w,
                    images/leo/000244280019-800.webp 800w,
                    images/leo/000244280019-1200.webp 1200w,
                    images/leo/000244280019-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280019.jpg"
                    alt="Image 12"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 15: 000244280022 -->
            <a href="images/leo/000244280022.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280022-400.webp 400w,
                    images/leo/000244280022-800.webp 800w,
                    images/leo/000244280022-1200.webp 1200w,
                    images/leo/000244280022-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280022.jpg"
                    alt="Image 15"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 18: 000244280025 -->
            <a href="images/leo/000244280025.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280025-400.webp 400w,
                    images/leo/000244280025-800.webp 800w,
                    images/leo/000244280025-1200.webp 1200w,
                    images/leo/000244280025-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280025.jpg"
                    alt="Image 18"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 21: 000244280029 -->
            <a href="images/leo/000244280029.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280029-400.webp 400w,
                    images/leo/000244280029-800.webp 800w,
                    images/leo/000244280029-1200.webp 1200w,
                    images/leo/000244280029-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280029.jpg"
                    alt="Image 21"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 24: 000244280032 -->
            <a href="images/leo/000244280032.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280032-400.webp 400w,
                    images/leo/000244280032-800.webp 800w,
                    images/leo/000244280032-1200.webp 1200w,
                    images/leo/000244280032-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280032.jpg"
                    alt="Image 24"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>

            <!-- 27: 000244280036 -->
            <a href="images/leo/000244280036.jpg" download target="_blank" class="image-link">
                <picture>
                <source
                    type="image/webp"
                    srcset="
                    images/leo/000244280036-400.webp 400w,
                    images/leo/000244280036-800.webp 800w,
                    images/leo/000244280036-1200.webp 1200w,
                    images/leo/000244280036-1600.webp 1600w
                    "
                    sizes="(max-width: 768px) 100vw, 33vw"
                >
                <img
                    src="images/leo/000244280036.jpg"
                    alt="Image 27"
                    class="image-item"
                    loading="lazy"
                >
                </picture>
            </a>
            </div>
        </div>
      </div>
    </div>
    </div>
    <div id="downloadModal" class="modal-overlay" style="display:none;">
    <div class="modal modal-box">
        <div class="modal-header">
            <h2 class="modal-title">before downloading...</h2>
            <button type="button" id="dlCancel" class="btn btn-close" aria-label="close modal"></button>
        </div>

        <form id="downloadForm" novalidate>
        <label class="modal-label">
            enter your name. <span aria-hidden="true" style="opacity:.7">*</span>
            <input id="dlName" class="modal-input" type="text" required autocomplete="name" />
        </label>

        <label class="modal-label">
            enter your email.
            <input id="dlEmail" class="modal-input" type="email" inputmode="email" autocomplete="email" />
        </label>

        <label class="modal-label">
            or enter your phone number.
            <input id="dlPhone" class="modal-input" type="tel" inputmode="tel" autocomplete="tel"/>
        </label>

        <div id="dlError" class="modal-error" role="alert" style="display:none;"></div>

        <div class="modal-actions">
            <button type="submit" id="dlConfirm" class="btn2 btn-primary">submit.</button>
        </div>
        </form>
    </div>
  </div>
  <div id="progressModal" class="modal-overlay" style="display:none;">
    <div class="modal modal-box progress-box">
        <div class="progress-content">
        <img src="images/user/run2.gif" alt="" class="progress-img" />
        <p id="progressText" class="progress-text">running</p>
        </div>
    </div>
  </div>
  <audio id="menuClickAudio" src="sounds/menu-click.mp3"></audio>

  <div id="userLightbox" class="suku-lightbox-overlay">
    <button class="suku-lightbox-arrow suku-lightbox-prev" aria-label="Previous image">&#10094;</button>
    <img class="suku-lightbox-image" src="" alt="">
    <button class="suku-lightbox-arrow suku-lightbox-next" aria-label="Next image">&#10095;</button>
  </div>

  <script type="module">
    // Import the functions you need from the SDKs you need

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";

    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
    import {
    getFirestore, doc, setDoc, updateDoc, increment, serverTimestamp,
    collection, addDoc
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // TODO: Add SDKs for Firebase products that you want to use

    // https://firebase.google.com/docs/web/setup#available-libraries


    // Your web app's Firebase configuration

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional

    const firebaseConfig = {

        apiKey: "AIzaSyAPHalnYFfFkCJspSeWNytSngnpEWC9lNk",

        authDomain: "nyamachoma-57d58.firebaseapp.com",

        projectId: "nyamachoma-57d58",

        storageBucket: "nyamachoma-57d58.firebasestorage.app",

        messagingSenderId: "1090224589648",

        appId: "1:1090224589648:web:c8a08e362ea132a7e6ba55",

        measurementId: "G-N7DGBF6Q79"

    };

    const app = initializeApp(firebaseConfig);

    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    const SESSION_KEY = 'nyamachoma_dl_user';

    function getSessionUser() {
    try { return JSON.parse(sessionStorage.getItem(SESSION_KEY) || 'null'); }
    catch { return null; }
    }
    function setSessionUser(user) {
    sessionStorage.setItem(SESSION_KEY, JSON.stringify(user));
    }
    function hasSessionUser() { return !!getSessionUser(); }

    function imageIdFromUrl(url) {
    try {
        const u = new URL(url, window.location.href);
        return u.pathname.replace(/\//g,'__'); // safe doc id
    } catch {
        return url.replace(/\//g,'__');
    }
    }

    async function recordPhotoClick(url) {
    const id = imageIdFromUrl(url);
    const ref = doc(db, 'photoClicks-leo', id);
    try {
        await setDoc(ref, { url, count: increment(1), updatedAt: serverTimestamp() }, { merge: true });
    } catch (e) { /* non-blocking */ }
    }

    async function logDownload({ mode, urls, user }) {
    try {
        await addDoc(collection(db, 'downloads-leo'), {
        mode, 
        count: urls.length,
        filenames: urls.map(filenameFromUrl),
        user,
        createdAt: serverTimestamp()
        });
    } catch (e) { /* non-blocking */ }
    }

    function playAndNavigate(url) {
    const audio = document.getElementById('menuClickAudio');
    audio.currentTime = 0;
    audio.play();
    setTimeout(() => {
        window.location.href = url;
    }, 180);
    }

    function playClick() {
    const audio = document.getElementById('menuClickAudio');
    if (!audio) return;
    audio.currentTime = 0;
    audio.play().catch(() => {});
    }


    document.querySelector('.option-container').onclick = function(e) {
    e.stopPropagation();
    playAndNavigate('leo.html');
    };

    document.querySelector('.title-container').onclick = function(e) {
    e.stopPropagation();
    playAndNavigate('index.html');
    };

    async function blobFromUrl(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
    return await res.blob();
    }

    function filenameFromUrl(url) {
    try {
        const u = new URL(url, window.location.href);
        const name = u.pathname.split('/').pop();
        return name || 'image';
    } catch {
        return url.split('/').pop() || 'image';
    }
    }

    async function zipAndDownload(urls, zipName = 'photos.zip') {
    const zip = new window.JSZip();
    const folder = zip.folder('photos');

    const blobs = await Promise.all(
        urls.map(async (u) => {
        const blob = await blobFromUrl(u);
        return { name: filenameFromUrl(u), blob };
        })
    );

    blobs.forEach(({ name, blob }) => {
        folder.file(name, blob);
    });

    const zipBlob = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(zipBlob);
    a.download = zipName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    async function trackPageView({ oncePerSession = false } = {}) {
    const pagePath = window.location.pathname || '/';
    const pageKey  = pagePath.replace(/\//g, '__');
    const sessionFlag = `pv:${pagePath}`;

    if (oncePerSession && sessionStorage.getItem(sessionFlag)) return;

    try {
        await setDoc(
        doc(db, 'pageViews', pageKey),
        {
            path: pagePath,
            count: increment(1),
            updatedAt: serverTimestamp(),
            referrer: document.referrer || null
        },
        { merge: true }
        );
        if (oncePerSession) sessionStorage.setItem(sessionFlag, '1');
    } catch (e) {
        console.warn('page view log failed:', e);
    }
    }

    trackPageView({ oncePerSession: false });

    const rectangle = document.querySelector('.rectangle');
    const columnEls = Array.from(document.querySelectorAll('.image-column'));
    const columnLinks = columnEls.map(col =>
    Array.from(col.querySelectorAll('.image-link'))
    );

    const maxRows = Math.max(...columnLinks.map(col => col.length));

    const imageLinks = [];
    for (let row = 0; row < maxRows; row++) {
    for (let c = 0; c < columnLinks.length; c++) {
        const link = columnLinks[c][row];
        if (link) imageLinks.push(link);
    }
    }
    const toggleDownload = document.getElementById('downloadToggle');
    const downloadAllBtn = document.getElementById('downloadAllOption');
    const startDownloadBtn = document.getElementById('startDownloadOption');
    const downloadModal = document.getElementById('downloadModal');
    const downloadForm  = document.getElementById('downloadForm');
    const dlName  = document.getElementById('dlName');
    const dlEmail = document.getElementById('dlEmail');
    const dlPhone = document.getElementById('dlPhone');
    const dlError = document.getElementById('dlError');
    const dlCancel = document.getElementById('dlCancel');
    const dlConfirm = document.getElementById('dlConfirm');
    const progressModal = document.getElementById('progressModal');
    const progressText  = document.getElementById('progressText');


        // ---------- LIGHTBOX FOR USER GALLERY ----------

    const userLightbox = document.getElementById('userLightbox');
    const userLightboxImg = userLightbox.querySelector('.suku-lightbox-image');
    const userPrevBtn = userLightbox.querySelector('.suku-lightbox-prev');
    const userNextBtn = userLightbox.querySelector('.suku-lightbox-next');

    let currentIndex = 0;

    function showLightboxImage(index) {
      if (!imageLinks.length) return;
      currentIndex = index;

      const linkEl = imageLinks[currentIndex];
      const imgEl  = linkEl.querySelector('img');

      if (!imgEl) return;

      // Use the full-size URL from href if present, else fallback to img.src
      const src = linkEl.getAttribute('href') || imgEl.src;
      const alt = imgEl.alt || '';

      userLightboxImg.src = src;
      userLightboxImg.alt = alt;

      // Track photoclick for the image currently being viewed in the lightbox
      recordPhotoClick(src);
      logEvent(analytics, 'photo_click', {
        image_id: filenameFromUrl(src)
      });
    }

    function openUserLightbox(index) {
      showLightboxImage(index);
      userLightbox.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    function closeUserLightbox() {
      userLightbox.classList.remove('is-open');
      document.body.style.overflow = '';
    }

    function showUserNext(direction) {
      if (!imageLinks.length) return;
      const total = imageLinks.length;
      currentIndex = (currentIndex + direction + total) % total;
      showLightboxImage(currentIndex);
    }

    let dotsInterval = null;
    let progressMinUntil = 0;

    function showProgress() {
    let dots = 0;
    progressText.textContent = 'running';
    progressModal.style.display = 'flex';
    document.body.classList.add('modal-open');

    progressMinUntil = Date.now() + (4 * 275 * 2);

    dotsInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        progressText.textContent = 'running' + '.'.repeat(dots);
    }, 275);
    }

    function hideProgress() {
    return new Promise((resolve) => {
        const remaining = Math.max(0, progressMinUntil - Date.now());
        setTimeout(() => {
        if (dotsInterval) clearInterval(dotsInterval);
        dotsInterval = null;
        progressModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        resolve();
        }, remaining);
    });
    }
    function waitForMinCycles() {
    return new Promise((resolve) => {
        const remaining = Math.max(0, progressMinUntil - Date.now());
        setTimeout(resolve, remaining);
    });
    }

    let pendingDownload = null;

    function openDownloadModal(urls, mode) {
    pendingDownload = { mode, urls };
    dlError.style.display = 'none';
    dlError.textContent = '';
    downloadModal.style.display = 'flex';
    document.body.classList.add('modal-open');
    playClick();
    setTimeout(() => dlName.focus(), 0);
    }
    function closeDownloadModal() {
    downloadModal.style.display = 'none';
    document.body.classList.remove('modal-open');
    pendingDownload = null;
    }

    function isValidEmail(v) {
    if (!v) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim());
    }
    function isValidPhone(v) {
    if (!v) return false;
    const digits = (v.match(/\d/g) || []).length;
    return digits >= 7; 
    }

    dlCancel.addEventListener('click', () => {
    playClick();
    closeDownloadModal();
    });

    downloadModal.addEventListener('click', (e) => {
    if (e.target === downloadModal) {
        playClick();
        closeDownloadModal();
    }
    });

    downloadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    playClick();

    const name  = dlName.value.trim();
    const email = dlEmail.value.trim();
    const phone = dlPhone.value.trim();

    if (!name) {
        dlError.textContent = 'please enter your name.';
        dlError.style.display = 'block';
        dlName.focus();
        return;
    }
    if (!(isValidEmail(email) || isValidPhone(phone))) {
        dlError.textContent = 'enter a valid email or phone number.';
        dlError.style.display = 'block';
        (email ? dlEmail : dlPhone).focus();
        return;
    }

    dlConfirm.disabled = true;

    try {
        if (!pendingDownload) return;
        const { mode, urls } = pendingDownload;

        const user = { name, email: email || null, phone: phone || null };
        setSessionUser(user);

        closeDownloadModal();
        await startDownloadFlow(urls, mode);
        } catch (err) {
        console.error(err);
        alert('Sorry, something went wrong starting your download.');
        } finally {
        dlConfirm.disabled = false;
        exitDownloadMode();
        }
    });



    let downloadMode = false;
    const selected = new Set();

    function disableImageLinks() {
        imageLinks.forEach(a => {
        if (!a.dataset.href) a.dataset.href = a.getAttribute('href') || '';
        a.removeAttribute('href');
        });
    }

    function restoreImageLinks() {
        imageLinks.forEach(a => {
        if (a.dataset.href !== undefined) {
            a.setAttribute('href', a.dataset.href);
            delete a.dataset.href;
        }
        });
    }
        imageLinks.forEach((a, index) => {
      a.addEventListener('click', (e) => {
        // Always prevent the default "open in new tab"
        e.preventDefault();

        // If we are in download mode, let the rectangle listener handle selection
        if (downloadMode) {
          return;
        }

        // Normal mode: open lightbox with sound
        playClick();
        openUserLightbox(index);
      });
    });

        // Lightbox arrows
    userPrevBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      playClick();
      showUserNext(-1);
    });

    userNextBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      playClick();
      showUserNext(1);
    });

    // Click outside image closes lightbox
    userLightbox.addEventListener('click', (e) => {
      if (e.target === userLightbox) {
        playClick();
        closeUserLightbox();
      }
    });

    // Keyboard: Esc to close, arrows to navigate (with sound)
    document.addEventListener('keydown', (e) => {
      if (!userLightbox.classList.contains('is-open')) return;

      if (e.key === 'Escape') {
        playClick();
        closeUserLightbox();
      } else if (e.key === 'ArrowRight') {
        playClick();
        showUserNext(1);
      } else if (e.key === 'ArrowLeft') {
        playClick();
        showUserNext(-1);
      }
    });


    async function startDownloadFlow(urls, mode) {
        logEvent(analytics, 'download_start', { mode, count: urls.length });
        showProgress();
        await waitForMinCycles();
        await hideProgress();

        if (mode === 'selected') {
            await new Promise((resolve) => batchDownload(urls, resolve));
        } else {
            await zipAndDownload(urls, 'nyamachoma.zip');
        }

        logEvent(analytics, 'download_complete', { mode, count: urls.length });

        const user = getSessionUser();
        logDownload({ mode, urls, user });
    }


    function enterDownloadMode() {
        if (downloadMode) return;
        downloadMode = true;
        document.body.classList.add('download-mode');
        disableImageLinks();
    }

    function clearSelections() {
        selected.forEach(img => img.classList.remove('selected'));
        selected.clear();
    }

    function exitDownloadMode() {
        if (!downloadMode) return;
        downloadMode = false;
        document.body.classList.remove('download-mode');
        restoreImageLinks();
        clearSelections();
    }

    toggleDownload.addEventListener('click', (e) => {
        e.stopPropagation();
        playClick();
        enterDownloadMode();
    });

    rectangle.addEventListener('click', (e) => {
        e.stopPropagation();
        playClick();
        if (!downloadMode) return;

        const img = e.target.closest('.image-item');
        if (img) {
        e.preventDefault();
        img.classList.toggle('selected');
        if (img.classList.contains('selected')) {
            selected.add(img);
        } else {
            selected.delete(img);
        }
        return;
        }
    });

    startDownloadBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    playClick();
    if (!downloadMode || selected.size === 0) return;

    const urls = Array.from(selected).map(img => {
        const a = img.closest('a');
        const href = (a && (a.dataset.href || a.getAttribute('href'))) || img.getAttribute('src');
        return href;
    }).filter(Boolean);
    if (!urls.length) return;

    if (hasSessionUser()) {
        startDownloadFlow(urls, 'selected').finally(exitDownloadMode);
    } else {
        openDownloadModal(urls, 'selected');
    }
    });


    downloadAllBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    playClick();

    const urls = imageLinks
        .map(a => a.dataset.href || a.getAttribute('href'))
        .filter(Boolean);
    if (!urls.length) return;

    if (hasSessionUser()) {
        startDownloadFlow(urls, 'all').finally(exitDownloadMode);
    } else {
        openDownloadModal(urls, 'all');
    }
    });

    document.addEventListener('click', (e) => {
        if (!downloadMode) return;
        if (document.body.classList.contains('modal-open')) return;

        const clickedInsideRectangle = rectangle.contains(e.target);
        const clickedControls = toggleDownload.contains(e.target) ||
                                downloadAllBtn.contains(e.target) ||
                                startDownloadBtn.contains(e.target);

        if (!clickedInsideRectangle && !clickedControls) {
        exitDownloadMode();
        }
    });

    function batchDownload(urls, onDone) {
        let i = 0;
        const next = () => {
        if (i >= urls.length) { onDone && onDone(); return; }
        const url = urls[i++];
        const a = document.createElement('a');
        a.href = url;
        a.download = url.split('/').pop() || 'image';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(next, 160);
        };
        next();
    }
  </script>
</body>
</html>