<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>usc sis</title>
  <link rel="stylesheet" href="styles/styles-user.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
  <link rel="manifest" href="/site.webmanifest">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="title-container" style="position: relative;" onclick="window.location.href='index.html'">
        <h1 class="title" style="position: relative; z-index: 1;">nyama choma</h1> 
        <div class="title-ellipse" style="position: absolute; z-index: 0;"></div>
    </div>
    <div class="header-options">
      <div class="triangle-container">
        <div class="parallelogram"></div>
        <div class="parallelogram-text-alex">usc sis</div>
      </div>
    </div>
  </div>
  <div class="gallery-container">
    <div class="column left-column">
      <div class="option-container" onclick="window.location.href='uscsis.html'">
        <h1 class="option-shade-1">picha</h1> 
        <h1 class="option-text">photos</h1> 
      </div>
      <div class="triangle-container-2" id="downloadToggle">
        <div class="triangle-down"></div>
        <div class="triangle-text-about">download</div>
      </div>
      <div class="download-option-container" id="downloadAllOption">
        <div class="download-option"></div>
        <div class="download-option-text">download all?</div>
      </div>
      <div class="download-option-container" id="startDownloadOption">
        <div class="download-option"></div>
        <div class="download-option-text-2">start download.</div>
      </div>
    </div>
    <div class="column right-column">
      <div class="rectangle">
        <div class="scrollable-content">
            <div class="image-column">
                <a href="images/uscsis/0dylang_0dylang-R3-010-3A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-010-3A.jpg" alt="Image 1" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-016-6A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-016-6A.jpg" alt="Image 4" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-022-9A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-022-9A.jpg" alt="Image 7" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-028-12A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-028-12A.jpg" alt="Image 10" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-034-15A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-034-15A.jpg" alt="Image 13" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-040-18A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-040-18A.jpg" alt="Image 16" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-046-21A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-046-21A.jpg" alt="Image 19" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-052-24A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-052-24A.jpg" alt="Image 22" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-058-27A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-058-27A.jpg" alt="Image 25" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-064-30A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-064-30A.jpg" alt="Image 28" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-070-33A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-070-33A.jpg" alt="Image 31" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-006-1A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-006-1A.jpg" alt="Image 34" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-012-4A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-012-4A.jpg" alt="Image 37" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-018-7A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-018-7A.jpg" alt="Image 40" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-024-10A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-024-10A.jpg" alt="Image 43" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-031-14.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-031-14.jpg" alt="Image 46" class="image-item">
                </a>
            </div>
            <div class="image-column">
                <a href="images/uscsis/0dylang_0dylang-R3-012-4A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-012-4A.jpg" alt="Image 2" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-018-7A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-018-7A.jpg" alt="Image 5" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-024-10A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-024-10A.jpg" alt="Image 8" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-030-13A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-030-13A.jpg" alt="Image 11" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-036-16A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-036-16A.jpg" alt="Image 14" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-042-19A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-042-19A.jpg" alt="Image 17" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-048-22A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-048-22A.jpg" alt="Image 20" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-054-25A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-054-25A.jpg" alt="Image 23" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-060-28A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-060-28A.jpg" alt="Image 26" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-066-31A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-066-31A.jpg" alt="Image 29" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-072-34A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-072-34A.jpg" alt="Image 32" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-008-2A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-008-2A.jpg" alt="Image 35" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-014-5A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-014-5A.jpg" alt="Image 38" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-020-8A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-020-8A.jpg" alt="Image 41" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-026-11A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-026-11A.jpg" alt="Image 44" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-035-16.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-035-16.jpg" alt="Image 47" class="image-item">
                </a>
            </div>

            <div class="image-column">
                <a href="images/uscsis/0dylang_0dylang-R3-014-5A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-014-5A.jpg" alt="Image 3" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-020-8A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-020-8A.jpg" alt="Image 6" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-026-11A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-026-11A.jpg" alt="Image 9" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-032-14A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-032-14A.jpg" alt="Image 12" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-038-17A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-038-17A.jpg" alt="Image 15" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-044-20A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-044-20A.jpg" alt="Image 18" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-050-23A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-050-23A.jpg" alt="Image 21" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-056-26A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-056-26A.jpg" alt="Image 24" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-062-29A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-062-29A.jpg" alt="Image 27" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R3-068-32A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R3-068-32A.jpg" alt="Image 30" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-004-0A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-004-0A.jpg" alt="Image 33" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-010-3A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-010-3A.jpg" alt="Image 36" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-016-6A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-016-6A.jpg" alt="Image 39" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-022-9A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-022-9A.jpg" alt="Image 42" class="image-item">
                </a>
                <a href="images/uscsis/0dylang_0dylang-R1-028-12A.jpg" target="_blank" class="image-link">
                <img src="images/uscsis/0dylang_0dylang-R1-028-12A.jpg" alt="Image 45" class="image-item">
                </a>
            </div>
        </div>
      </div>
    </div>
    </div>
    <div id="downloadModal" class="modal-overlay" style="display:none;">
    <div class="modal modal-box">
        <div class="modal-header">
            <h2 class="modal-title">before downloading...</h2>
            <button type="button" id="dlCancel" class="btn btn-close" aria-label="close modal"></button>
        </div>

        <form id="downloadForm" novalidate>
        <label class="modal-label">
            enter your name. <span aria-hidden="true" style="opacity:.7">*</span>
            <input id="dlName" class="modal-input" type="text" required autocomplete="name" />
        </label>

        <label class="modal-label">
            enter your email.
            <input id="dlEmail" class="modal-input" type="email" inputmode="email" autocomplete="email" />
        </label>

        <label class="modal-label">
            or enter your phone number.
            <input id="dlPhone" class="modal-input" type="tel" inputmode="tel" autocomplete="tel"/>
        </label>

        <div id="dlError" class="modal-error" role="alert" style="display:none;"></div>

        <div class="modal-actions">
            <button type="submit" id="dlConfirm" class="btn2 btn-primary">submit.</button>
        </div>
        </form>
    </div>
  </div>
  <div id="progressModal" class="modal-overlay" style="display:none;">
    <div class="modal modal-box progress-box">
        <div class="progress-content">
        <img src="images/user/run2.png" alt="" class="progress-img" />
        <p id="progressText" class="progress-text">running</p>
        </div>
    </div>
  </div>
  <audio id="menuClickAudio" src="sounds/menu-click.mp3"></audio>
  <script type="module">
    // Import the functions you need from the SDKs you need

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";

    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
    import {
    getFirestore, doc, setDoc, updateDoc, increment, serverTimestamp,
    collection, addDoc
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // TODO: Add SDKs for Firebase products that you want to use

    // https://firebase.google.com/docs/web/setup#available-libraries


    // Your web app's Firebase configuration

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional

    const firebaseConfig = {

        apiKey: "AIzaSyAPHalnYFfFkCJspSeWNytSngnpEWC9lNk",

        authDomain: "nyamachoma-57d58.firebaseapp.com",

        projectId: "nyamachoma-57d58",

        storageBucket: "nyamachoma-57d58.firebasestorage.app",

        messagingSenderId: "1090224589648",

        appId: "1:1090224589648:web:c8a08e362ea132a7e6ba55",

        measurementId: "G-N7DGBF6Q79"

    };

    const app = initializeApp(firebaseConfig);

    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    const SESSION_KEY = 'nyamachoma_dl_user';

    function getSessionUser() {
    try { return JSON.parse(sessionStorage.getItem(SESSION_KEY) || 'null'); }
    catch { return null; }
    }
    function setSessionUser(user) {
    sessionStorage.setItem(SESSION_KEY, JSON.stringify(user));
    }
    function hasSessionUser() { return !!getSessionUser(); }

    function imageIdFromUrl(url) {
    try {
        const u = new URL(url, window.location.href);
        return u.pathname.replace(/\//g,'__'); // safe doc id
    } catch {
        return url.replace(/\//g,'__');
    }
    }

    async function recordPhotoClick(url) {
    const id = imageIdFromUrl(url);
    const ref = doc(db, 'photoClicks-uscsis', id);
    try {
        await setDoc(ref, { url, count: increment(1), updatedAt: serverTimestamp() }, { merge: true });
    } catch (e) { /* non-blocking */ }
    }

    async function logDownload({ mode, urls, user }) {
    try {
        await addDoc(collection(db, 'downloads-uscsis'), {
        mode, 
        count: urls.length,
        filenames: urls.map(filenameFromUrl),
        user,
        createdAt: serverTimestamp()
        });
    } catch (e) { /* non-blocking */ }
    }

    function playAndNavigate(url) {
    const audio = document.getElementById('menuClickAudio');
    audio.currentTime = 0;
    audio.play();
    setTimeout(() => {
        window.location.href = url;
    }, 180);
    }

    function playClick() {
    const audio = document.getElementById('menuClickAudio');
    if (!audio) return;
    audio.currentTime = 0;
    audio.play().catch(() => {});
    }


    document.querySelector('.option-container').onclick = function(e) {
    e.stopPropagation();
    playAndNavigate('uscsis.html');
    };

    document.querySelector('.title-container').onclick = function(e) {
    e.stopPropagation();
    playAndNavigate('index.html');
    };

    async function blobFromUrl(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
    return await res.blob();
    }

    function filenameFromUrl(url) {
    try {
        const u = new URL(url, window.location.href);
        const name = u.pathname.split('/').pop();
        return name || 'image';
    } catch {
        return url.split('/').pop() || 'image';
    }
    }

    async function zipAndDownload(urls, zipName = 'photos.zip') {
    const zip = new window.JSZip();
    const folder = zip.folder('photos');

    const blobs = await Promise.all(
        urls.map(async (u) => {
        const blob = await blobFromUrl(u);
        return { name: filenameFromUrl(u), blob };
        })
    );

    blobs.forEach(({ name, blob }) => {
        folder.file(name, blob);
    });

    const zipBlob = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(zipBlob);
    a.download = zipName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    

    const rectangle = document.querySelector('.rectangle');
    const imageLinks = Array.from(document.querySelectorAll('.image-link'));
    const toggleDownload = document.getElementById('downloadToggle');
    const downloadAllBtn = document.getElementById('downloadAllOption');
    const startDownloadBtn = document.getElementById('startDownloadOption');
    const downloadModal = document.getElementById('downloadModal');
    const downloadForm  = document.getElementById('downloadForm');
    const dlName  = document.getElementById('dlName');
    const dlEmail = document.getElementById('dlEmail');
    const dlPhone = document.getElementById('dlPhone');
    const dlError = document.getElementById('dlError');
    const dlCancel = document.getElementById('dlCancel');
    const dlConfirm = document.getElementById('dlConfirm');
    const progressModal = document.getElementById('progressModal');
    const progressText  = document.getElementById('progressText');

    let dotsInterval = null;
    let progressMinUntil = 0;

    function showProgress() {
    let dots = 0;
    progressText.textContent = 'running';
    progressModal.style.display = 'flex';
    document.body.classList.add('modal-open');

    progressMinUntil = Date.now() + (4 * 275 * 2);

    dotsInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        progressText.textContent = 'running' + '.'.repeat(dots);
    }, 275);
    }

    function hideProgress() {
    return new Promise((resolve) => {
        const remaining = Math.max(0, progressMinUntil - Date.now());
        setTimeout(() => {
        if (dotsInterval) clearInterval(dotsInterval);
        dotsInterval = null;
        progressModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        resolve();
        }, remaining);
    });
    }
    function waitForMinCycles() {
    return new Promise((resolve) => {
        const remaining = Math.max(0, progressMinUntil - Date.now());
        setTimeout(resolve, remaining);
    });
    }

    let pendingDownload = null;

    function openDownloadModal(urls, mode) {
    pendingDownload = { mode, urls };
    dlError.style.display = 'none';
    dlError.textContent = '';
    downloadModal.style.display = 'flex';
    document.body.classList.add('modal-open');
    playClick();
    setTimeout(() => dlName.focus(), 0);
    }
    function closeDownloadModal() {
    downloadModal.style.display = 'none';
    document.body.classList.remove('modal-open');
    pendingDownload = null;
    }

    function isValidEmail(v) {
    if (!v) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim());
    }
    function isValidPhone(v) {
    if (!v) return false;
    const digits = (v.match(/\d/g) || []).length;
    return digits >= 7; 
    }

    dlCancel.addEventListener('click', () => {
    playClick();
    closeDownloadModal();
    });

    downloadModal.addEventListener('click', (e) => {
    if (e.target === downloadModal) {
        playClick();
        closeDownloadModal();
    }
    });

    downloadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    playClick();

    const name  = dlName.value.trim();
    const email = dlEmail.value.trim();
    const phone = dlPhone.value.trim();

    if (!name) {
        dlError.textContent = 'please enter your name.';
        dlError.style.display = 'block';
        dlName.focus();
        return;
    }
    if (!(isValidEmail(email) || isValidPhone(phone))) {
        dlError.textContent = 'enter a valid email or phone number.';
        dlError.style.display = 'block';
        (email ? dlEmail : dlPhone).focus();
        return;
    }

    dlConfirm.disabled = true;

    try {
        if (!pendingDownload) return;
        const { mode, urls } = pendingDownload;

        const user = { name, email: email || null, phone: phone || null };
        setSessionUser(user);

        closeDownloadModal();
        await startDownloadFlow(urls, mode);
        } catch (err) {
        console.error(err);
        alert('Sorry, something went wrong starting your download.');
        } finally {
        dlConfirm.disabled = false;
        exitDownloadMode();
        }
    });



    let downloadMode = false;
    const selected = new Set();

    function disableImageLinks() {
        imageLinks.forEach(a => {
        if (!a.dataset.href) a.dataset.href = a.getAttribute('href') || '';
        a.removeAttribute('href');
        });
    }

    function restoreImageLinks() {
        imageLinks.forEach(a => {
        if (a.dataset.href !== undefined) {
            a.setAttribute('href', a.dataset.href);
            delete a.dataset.href;
        }
        });
    }
    imageLinks.forEach(a => {
    a.addEventListener('click', () => {
        if (!downloadMode) {
        const href = a.getAttribute('href');
        recordPhotoClick(href);
        logEvent(analytics, 'photo_click', {
            image_id: filenameFromUrl(href) 
        });
        }
    }, { capture: true });
    });

    async function startDownloadFlow(urls, mode) {
        logEvent(analytics, 'download_start', { mode, count: urls.length });
        showProgress();
        await waitForMinCycles();
        await hideProgress();

        if (mode === 'selected') {
            await new Promise((resolve) => batchDownload(urls, resolve));
        } else {
            await zipAndDownload(urls, 'nyamachoma.zip');
        }

        logEvent(analytics, 'download_complete', { mode, count: urls.length });

        const user = getSessionUser();
        logDownload({ mode, urls, user });
    }


    function enterDownloadMode() {
        if (downloadMode) return;
        downloadMode = true;
        document.body.classList.add('download-mode');
        disableImageLinks();
    }

    function clearSelections() {
        selected.forEach(img => img.classList.remove('selected'));
        selected.clear();
    }

    function exitDownloadMode() {
        if (!downloadMode) return;
        downloadMode = false;
        document.body.classList.remove('download-mode');
        restoreImageLinks();
        clearSelections();
    }

    toggleDownload.addEventListener('click', (e) => {
        e.stopPropagation();
        playClick();
        enterDownloadMode();
    });

    rectangle.addEventListener('click', (e) => {
        e.stopPropagation();
        playClick();
        if (!downloadMode) return;

        const img = e.target.closest('.image-item');
        if (img) {
        e.preventDefault();
        img.classList.toggle('selected');
        if (img.classList.contains('selected')) {
            selected.add(img);
        } else {
            selected.delete(img);
        }
        return;
        }
    });

    startDownloadBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    playClick();
    if (!downloadMode || selected.size === 0) return;

    const urls = Array.from(selected).map(img => {
        const a = img.closest('a');
        const href = (a && (a.dataset.href || a.getAttribute('href'))) || img.getAttribute('src');
        return href;
    }).filter(Boolean);
    if (!urls.length) return;

    if (hasSessionUser()) {
        startDownloadFlow(urls, 'selected').finally(exitDownloadMode);
    } else {
        openDownloadModal(urls, 'selected');
    }
    });


    downloadAllBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    playClick();

    const urls = imageLinks
        .map(a => a.dataset.href || a.getAttribute('href'))
        .filter(Boolean);
    if (!urls.length) return;

    if (hasSessionUser()) {
        startDownloadFlow(urls, 'all').finally(exitDownloadMode);
    } else {
        openDownloadModal(urls, 'all');
    }
    });

    document.addEventListener('click', (e) => {
        if (!downloadMode) return;
        if (document.body.classList.contains('modal-open')) return;

        const clickedInsideRectangle = rectangle.contains(e.target);
        const clickedControls = toggleDownload.contains(e.target) ||
                                downloadAllBtn.contains(e.target) ||
                                startDownloadBtn.contains(e.target);

        if (!clickedInsideRectangle && !clickedControls) {
        exitDownloadMode();
        }
    });

    function batchDownload(urls, onDone) {
        let i = 0;
        const next = () => {
        if (i >= urls.length) { onDone && onDone(); return; }
        const url = urls[i++];
        const a = document.createElement('a');
        a.href = url;
        a.download = url.split('/').pop() || 'image';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(next, 160);
        };
        next();
    }

    (async function trackPageView() {
    const pagePath = window.location.pathname || '/';
    const pageKey  = pagePath.replace(/\//g, '__');

    try {
        await setDoc(
        doc(db, 'pageViews', pageKey),
        {
            path: pagePath,
            count: increment(1),
            updatedAt: serverTimestamp(),
            referrer: document.referrer || null,
            ua: navigator.userAgent
        },
        { merge: true }
        );
    } catch (e) {
        console.warn('page view log failed:', e);
    }
    })();

  </script>
</body>
</html>